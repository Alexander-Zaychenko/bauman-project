<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чаты — SkillUp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <div class="logo"><a href="index.html"><img src="images/SkillUpSquare.png" class="logo-img"><span class="brand-text">SkillUp</span></a></div>
    <div class="auth"><a href="login.html">Войти</a></div>
  </div>
</header>
<main class="site-main">
  <div class="container">
    <section class="card chat-container">
      <div class="chat-grid">
        <aside class="chat-list">
          <div class="chat-list-header">Чаты</div>
          <div id="chatListRoot" class="chat-list-items">Загрузка...</div>
        </aside>
        <div class="chat-panel">
          <div id="chatPanelRoot" class="chat-panel-root">
            <div class="chat-empty">Выберите чат слева или примите запрос, чтобы начать общение.</div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>
<footer class="site-footer"><div class="container footer-inner"><div class="footer-left"><div class="logo footer-logo"><a href="index.html">SkillUp</a></div><p class="footer-copy">© 2025 SkillUp.</p></div></div></footer>
<script src="scripts.js"></script>
<script>
  function getQueryParam(name) { try { return new URLSearchParams(window.location.search).get(name); } catch (e) { return null; } }
  document.addEventListener('DOMContentLoaded', async function () {
    renderAuthWidget();
    const user = checkAuth(); if (!user) { window.location.href = 'login.html'; return; }
    const userId = user.id;
    const listRoot = document.getElementById('chatListRoot');
    const panelRoot = document.getElementById('chatPanelRoot');

    async function openChat(chatId) {
      panelRoot.innerHTML = 'Загрузка...';
      const j = await getChatById(chatId);
      if (!j || !j.chat) { panelRoot.innerHTML = '<div class="chat-empty">Чат не найден.</div>'; return; }
      const chat = j.chat; const messages = j.messages || []; const request = j.request || {};
      const otherId = (userId === chat.creatorId) ? chat.accepterId : chat.creatorId;
      let otherName = 'Собеседник';
      if (otherId) {
        try { const ru = await fetch('/api/users/' + encodeURIComponent(otherId)); if (ru.ok) { const uj = await ru.json(); otherName = (uj.user && uj.user.name) || otherName; } } catch (e) {}
      }
      // build header
      panelRoot.innerHTML = '';
      const headerDiv = document.createElement('div'); headerDiv.className = 'chat-header';
      const opponentWrap = document.createElement('div'); opponentWrap.className = 'chat-opponent';
      const avatarEl = document.createElement('div'); avatarEl.className = 'avatar'; avatarEl.textContent = '〤';
      const metaWrap = document.createElement('div'); metaWrap.className = 'meta';
      const nameDiv = document.createElement('div'); nameDiv.className = 'name'; nameDiv.textContent = escapeHtml(otherName);
      const subDiv = document.createElement('div'); subDiv.className = 'sub'; subDiv.textContent = escapeHtml(request.title || request.subject || '');
      metaWrap.appendChild(nameDiv); metaWrap.appendChild(subDiv);
      opponentWrap.appendChild(avatarEl); opponentWrap.appendChild(metaWrap);
      const actionsContainer = document.createElement('div'); actionsContainer.className = 'chat-actions'; actionsContainer.id = 'chatActions';
      headerDiv.appendChild(opponentWrap); headerDiv.appendChild(actionsContainer);

      // messages container
      const messagesContainer = document.createElement('div'); messagesContainer.className = 'chat-messages'; messagesContainer.id = 'chatMessages';
      messages.forEach(m => {
        const fromMe = (m.senderId === userId);
        const node = document.createElement('div'); node.className = 'chat-msg' + (fromMe ? ' me' : '');
        const msgText = document.createElement('div'); msgText.className = 'msg-text'; msgText.textContent = escapeHtml(m.text);
        const msgMeta = document.createElement('div'); msgMeta.className = 'msg-meta'; msgMeta.textContent = new Date(m.createdAt||0).toLocaleString();
        node.appendChild(msgText); node.appendChild(msgMeta);
        messagesContainer.appendChild(node);
      });

      // composer
      const composer = document.createElement('div'); composer.className = 'chat-composer';
      const textarea = document.createElement('textarea'); textarea.id = 'chatInput'; textarea.placeholder = 'Напишите сообщение...';
      const sendBtnEl = document.createElement('button'); sendBtnEl.id = 'chatSend'; sendBtnEl.className = 'btn-create'; sendBtnEl.textContent = 'Отправить';
      composer.appendChild(textarea); composer.appendChild(sendBtnEl);

      panelRoot.appendChild(headerDiv); panelRoot.appendChild(messagesContainer); panelRoot.appendChild(composer);

      const actions = document.getElementById('chatActions');
      if (actions) {
        actions.innerHTML = '';
        // show actions only when chat is active
        if (chat.status === 'active') {
          if (userId === chat.accepterId) {
            const btn = document.createElement('button'); btn.className = 'btn-secondary'; btn.textContent = 'Отказаться'; btn.addEventListener('click', async () => {
              if (!confirm('Вы действительно хотите отказаться от выполнения?')) return;
              const r = await cancelChat(chat.id);
              if (r && r.success) {
                alert('Вы отказались — запрос снова доступен.');
                await loadChats();
                panelRoot.innerHTML = '<div class="chat-empty">Выберите чат слева.</div>';
              } else if (r && r.error) {
                alert('Не удалось отказаться: ' + (r.error || 'ошибка'));
                await loadChats();
                openChat(chat.id);
              } else alert('Не удалось отказаться');
            }); actions.appendChild(btn);
          }
          if (userId === chat.creatorId) {
            const btn = document.createElement('button'); btn.className = 'btn-create'; btn.textContent = 'Подтвердить выполнение'; btn.addEventListener('click', async () => {
              if (!confirm('Подтвердить выполнение задания?')) return;
              const r = await confirmChat(chat.id);
              if (r && r.success) { alert('Выполнение подтверждено.'); await loadChats(); openChat(chat.id); }
              else if (r && r.error) { alert('Не удалось подтвердить: ' + (r.error || 'ошибка')); await loadChats(); openChat(chat.id); }
              else alert('Не удалось подтвердить');
            }); actions.appendChild(btn);
          }
        }
      }

      // send handler
      const sendBtn = sendBtnEl;
      const input = document.getElementById('chatInput');
      const messagesEl = document.getElementById('chatMessages');
      sendBtn.addEventListener('click', async () => {
        const text = (input.value || '').trim(); if (!text) return;
        const r = await postChatMessage(chat.id, userId, text);
        if (r && r.success && r.message) {
          const mm = r.message; const node = document.createElement('div'); node.className = 'chat-msg me';
          const mmText = document.createElement('div'); mmText.className = 'msg-text'; mmText.textContent = escapeHtml(mm.text);
          const mmMeta = document.createElement('div'); mmMeta.className = 'msg-meta'; mmMeta.textContent = new Date(mm.createdAt||0).toLocaleString();
          node.appendChild(mmText); node.appendChild(mmMeta);
          messagesEl.appendChild(node); input.value = ''; messagesEl.scrollTop = messagesEl.scrollHeight;
        } else alert('Не удалось отправить сообщение');
      });
    }

    async function loadChats() {
      listRoot.innerHTML = 'Загрузка...';
      const chats = await getChats(userId);
      if (!chats || chats.length === 0) { listRoot.innerHTML = '<div style="color:#6b7280">Чатов пока нет.</div>'; return; }
      listRoot.innerHTML = '';
      for (const c of chats) {
        // fetch minimal info
        const info = await getChatById(c.id);
        const request = (info && info.request) || {};
        const otherId = (userId === c.creatorId) ? c.accepterId : c.creatorId;
        let otherName = otherId ? String(otherId) : 'Собеседник';
        if (otherId) { try { const ru = await fetch('/api/users/' + encodeURIComponent(otherId)); if (ru.ok) { const uj = await ru.json(); otherName = (uj.user && uj.user.name) || otherName; } } catch (e) {} }
        const el = document.createElement('div'); el.className = 'chat-list-item';
        const titleDiv = document.createElement('div'); titleDiv.className = 'chat-item-title'; titleDiv.textContent = escapeHtml(request.title || request.subject || 'Чат');
        const subDiv = document.createElement('div'); subDiv.className = 'chat-item-sub'; subDiv.textContent = escapeHtml(otherName) + ' • ' + escapeHtml(c.status||'');
        el.appendChild(titleDiv); el.appendChild(subDiv);
        el.addEventListener('click', () => { // open
          // mark selected
          document.querySelectorAll('.chat-list-item').forEach(n=>n.classList.remove('active'));
          el.classList.add('active');
          openChat(c.id);
        });
        listRoot.appendChild(el);
      }
      const openId = getQueryParam('chatId'); if (openId) { openChat(openId); }
    }

    await loadChats();
  });
</script>
</body>
</html>